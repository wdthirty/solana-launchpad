version: '3.8'

services:
  meteora-stream:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: meteora-stream
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      # Override specific env vars if needed
      - NEXT_PUBLIC_SOLANA_NETWORK=${NEXT_PUBLIC_SOLANA_NETWORK:-mainnet-beta}
    # No ports exposed - service only connects outbound to:
    # - Helius Laserstream (WebSocket)
    # - Supabase (HTTPS)
    # - Ably (HTTPS)
    # - Upstash Redis (HTTPS)
    # - Solana RPC (HTTPS)
    healthcheck:
      test: ["CMD", "pgrep", "-f", "unified-meteora-stream"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "awslogs"
      options:
        awslogs-region: "us-east-1"
        awslogs-group: "/aws/ec2/meteora-stream"
        awslogs-stream: "meteora-stream-service"
        awslogs-create-group: "true"
